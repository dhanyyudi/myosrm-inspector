<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>OSRM Inspector</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link rel="stylesheet" href="/styles/modern-styles.css" />
  </head>
  <body>
    <div id="app">
      <!-- Sidebar -->
      <div id="sidebar">
        <div class="sidebar-header">
          <h1><i class="fa fa-route"></i> OSRM Inspector</h1>
        </div>

        <div class="panels-container">
          <!-- Panel Routing -->
          <div class="panel" id="panel-routing">
            <div class="panel-header">
              <h2><i class="fa fa-map-marked-alt"></i> Routing</h2>
            </div>
            <div class="panel-content">
              <div class="waypoints-container">
                <div class="waypoint start">
                  <div class="waypoint-icon">
                    <i class="fa fa-map-marker-alt"></i>
                  </div>
                  <input
                    type="text"
                    id="start-point"
                    placeholder="Start Point"
                    class="waypoint-input"
                  />
                  <div class="waypoint-actions">
                    <button class="btn btn-icon" id="btn-clear-start">
                      <i class="fa fa-times"></i>
                    </button>
                  </div>
                </div>

                <div class="waypoint-separator">
                  <i class="fa fa-ellipsis-v"></i>
                </div>

                <div class="waypoint end">
                  <div class="waypoint-icon"><i class="fa fa-flag"></i></div>
                  <input
                    type="text"
                    id="end-point"
                    placeholder="End Point"
                    class="waypoint-input"
                  />
                  <div class="waypoint-actions">
                    <button class="btn btn-icon" id="btn-clear-end">
                      <i class="fa fa-times"></i>
                    </button>
                  </div>
                </div>
              </div>

              <!-- Waypoint buttons will be inserted here by JavaScript -->

              <div class="route-options">
                <div class="form-group">
                  <label for="profile">Profile:</label>
                  <select id="profile" class="form-control">
                    <option value="driving">Car</option>
                    <option value="walking">Walking</option>
                    <option value="cycling">Cycling</option>
                  </select>
                </div>

                <div class="form-group">
                  <label for="algorithm">Algorithm:</label>
                  <select id="algorithm" class="form-control">
                    <option value="mld">MLD (Multi-Level Dijkstra)</option>
                    <option value="ch">CH (Contraction Hierarchies)</option>
                  </select>
                </div>

                <!-- CURB toggle will be added here by JavaScript -->

                <!-- Auto-routing toggle will be added here by JavaScript -->

                <!-- Time selection will be added here by JavaScript -->
              </div>

              <div class="action-buttons">
                <button id="btn-find-route" class="btn btn-primary">
                  <i class="fa fa-search"></i> Find Route
                </button>
                <button id="btn-clear-route" class="btn btn-secondary">
                  <i class="fa fa-trash"></i> Clear
                </button>
              </div>
            </div>
          </div>

          <!-- Panel Debug -->
          <div class="panel" id="panel-debug">
            <div class="panel-header">
              <h2><i class="fa fa-bug"></i> Debug & Visualization</h2>
            </div>
            <div class="panel-content">
              <div class="debug-controls">
                <div class="debug-group">
                  <h3>Graph Visualization</h3>
                  <div class="toggle-buttons">
                    <button id="btn-show-nodes" class="btn btn-toggle">
                      <i class="fa fa-dot-circle"></i> Nodes
                    </button>
                    <button id="btn-show-edges" class="btn btn-toggle">
                      <i class="fa fa-project-diagram"></i> Edges
                    </button>
                    <button id="btn-show-cells" class="btn btn-toggle">
                      <i class="fa fa-th"></i> Cells
                    </button>
                  </div>
                </div>

                <div class="debug-group">
                  <h3>Route Debugging</h3>
                  <div class="toggle-buttons">
                    <button id="btn-show-turns" class="btn btn-toggle">
                      <i class="fa fa-turn-up"></i> Turns
                    </button>
                    <button id="btn-show-speed" class="btn btn-toggle">
                      <i class="fa fa-gauge-high"></i> Speed
                    </button>
                    <button id="btn-show-names" class="btn btn-toggle">
                      <i class="fa fa-road"></i> Road Names
                    </button>
                  </div>
                </div>
              </div>

              <button id="btn-clear-debug" class="btn btn-secondary">
                <i class="fa fa-broom"></i> Clear All Debug
              </button>
            </div>
          </div>

          <!-- URL Panel will be added here by JavaScript -->

          <!-- Panel Results -->
          <div class="panel" id="panel-results">
            <div class="panel-header">
              <h2><i class="fa fa-info-circle"></i> Route Information</h2>
            </div>
            <div class="panel-content">
              <div id="route-summary">
                <p class="no-route">No route is currently displayed.</p>
              </div>

              <div id="route-steps">
                <!-- Steps will be filled by JavaScript -->
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Map Container -->
      <div id="map-container">
        <div id="map"></div>

        <!-- Overlay Controls -->
        <div class="map-controls">
          <div class="map-control-group">
            <button id="btn-sidebar-toggle" class="btn btn-control">
              <i class="fa fa-bars"></i>
            </button>
          </div>
          <div class="map-control-group">
            <button id="btn-zoom-in" class="btn btn-control">
              <i class="fa fa-plus"></i>
            </button>
            <button id="btn-zoom-out" class="btn btn-control">
              <i class="fa fa-minus"></i>
            </button>
          </div>
        </div>

        <!-- Coordinates Display -->
        <div id="coordinates-display"></div>

        <!-- Loading Indicator -->
        <div id="loading-indicator">
          <div class="spinner"></div>
          <span>Processing...</span>
        </div>
      </div>
    </div>

    <!-- Scripts - Perhatikan urutan loading -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>

    <!-- 1. Load configuration first -->
    <script src="/js/config.js"></script>

    <!-- 2. Load utility modules -->
    <script src="/js/utils/format-utils.js"></script>
    <script src="/js/utils/csv-parser.js"></script>

    <!-- 3. Load core component modules -->
    <script src="/js/minimal-map.js"></script>
    <script src="/js/minimal-routing.js"></script>
    <script src="/js/minimal-debug.js"></script>

    <!-- 4. Load enhancement modules -->
    <script src="/js/waypoint-handler.js"></script>
    <script src="/js/url-handler.js"></script>

    <!-- 5. Load main application entry point last -->
    <script src="/js/enhanced-app.js"></script>

    <!-- Troubleshooting Shim - Add before </body> -->
    <script>
      // Check if main components are available, provide fallbacks if not
      console.log("üîç Running component diagnostic...");

      // Check if map global object exists
      if (!window.map) {
        console.warn("map object not found, creating placeholder");
        window.map = {
          invalidateSize: function () {
            console.log("Dummy invalidateSize called");
          },
          on: function () {
            console.log("Dummy map.on called");
          },
          getBounds: function () {
            return {
              getCenter: function () {
                return { lat: 0, lng: 0 };
              },
            };
          },
          fitBounds: function () {
            console.log("Dummy fitBounds called");
          },
          getCenter: function () {
            return { lat: 0, lng: 0 };
          },
          getZoom: function () {
            return 10;
          },
        };
      }

      // Check if mapLayers exists
      if (!window.mapLayers) {
        console.warn("mapLayers not found, creating placeholder");
        window.mapLayers = {
          route: { addLayer: function () {}, removeLayer: function () {} },
          waypoints: {
            addLayer: function () {},
            removeLayer: function () {},
            clearLayers: function () {},
          },
          routeSegments: {
            addLayer: function () {},
            removeLayer: function () {},
          },
          debug: {
            nodes: { addLayer: function () {}, clearLayers: function () {} },
            edges: { addLayer: function () {}, clearLayers: function () {} },
            cells: { addLayer: function () {}, clearLayers: function () {} },
            turns: { addLayer: function () {}, clearLayers: function () {} },
            speed: { addLayer: function () {}, clearLayers: function () {} },
            names: { addLayer: function () {}, clearLayers: function () {} },
          },
        };
      }

      // Check if waypointMarkers exists
      if (!window.waypointMarkers) {
        console.warn("waypointMarkers not found, creating placeholder");
        window.waypointMarkers = {
          start: null,
          end: null,
          via: [],
        };
      }

      // Provide core functions if they're missing
      if (typeof window.initMap !== "function") {
        console.warn("initMap not found, creating fallback function");
        window.initMap = function () {
          console.log("üîÑ Fallback initMap called");
          return window.map;
        };
      }

      if (typeof window.initRouting !== "function") {
        console.warn("initRouting not found, creating fallback function");
        window.initRouting = async function () {
          console.log("üîÑ Fallback initRouting called");
          return true;
        };
      }

      if (typeof window.initDebugTools !== "function") {
        console.warn("initDebugTools not found, creating fallback function");
        window.initDebugTools = function () {
          console.log("üîÑ Fallback initDebugTools called");
          return true;
        };
      }

      if (typeof window.findRouteWithMultipleWaypoints !== "function") {
        console.warn(
          "findRouteWithMultipleWaypoints not found, creating fallback"
        );
        window.findRouteWithMultipleWaypoints = function () {
          console.log("üîÑ Fallback findRouteWithMultipleWaypoints called");
        };
      }

      if (typeof window.updateWaypointsList !== "function") {
        console.warn("updateWaypointsList not found, creating fallback");
        window.updateWaypointsList = function () {
          console.log("üîÑ Fallback updateWaypointsList called");
        };
      }

      if (typeof window.getCurrentRouteData !== "function") {
        console.warn("getCurrentRouteData not found, creating fallback");
        window.getCurrentRouteData = function () {
          console.log("üîÑ Fallback getCurrentRouteData called");
          return null;
        };
      }

      // Check additional components
      if (typeof window.initWaypointHandler !== "function") {
        console.warn("initWaypointHandler not found, creating fallback");
        window.initWaypointHandler = function () {
          console.log("üîÑ Fallback initWaypointHandler called");
          return true;
        };
      }

      if (typeof window.initUrlHandler !== "function") {
        console.warn("initUrlHandler not found, creating fallback");
        window.initUrlHandler = function () {
          console.log("üîÑ Fallback initUrlHandler called");
          return true;
        };
      }

      // Verify all shims are in place
      console.log(
        "üîç Component verification complete. Shims in place for missing components."
      );

      // Make sure DOM has fully loaded
      window.addEventListener("load", function () {
        console.log("DOM and all resources fully loaded");

        // Verify all required components are available
        if (window.initMap && window.initRouting && window.initDebugTools) {
          console.log("‚úÖ All required components available");
        } else {
          console.error("‚ùå Missing required components!");
          if (!window.initMap) console.error("Missing: initMap");
          if (!window.initRouting) console.error("Missing: initRouting");
          if (!window.initDebugTools) console.error("Missing: initDebugTools");
        }

        // Check FormatUtils
        if (window.FormatUtils) {
          console.log("‚úÖ FormatUtils loaded");
        } else {
          console.error("‚ùå FormatUtils not available!");
        }
      });
    </script>
  </body>
</html>
